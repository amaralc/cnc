(Author: Calil Amaral)
(Description: It draws a cone of 10mm diameter and 10mm height)
(Data: 27/09/2019)

(General Configurations-----------------------------------)
N100
G91 (relative coordinates)

(R-Parameters---------------------------------------------)
N110

(dz)    #100 = 1 (layer height) (dz)
(a)     #101 = 15 (maximum overhang angle [deg]) (alpha)
(tan a) #102 = TAN[#101] (tg alpha)
(R)     #103 = 15  (maximum radius)
(rscale)#104 = 0.2 (rscale min to max)
(r)     #105 = #104 * #103 (minimum radius)

(dr = dz * tan angle)
(h)     #106 = [#103/#102 - #105/#102] (total height) (h)
(dr)    #107 = #100 * #102 (dr)
(R0)    #108 = #103 (current maximum radius)
(r0)    #109 = #105 (current minimum radius)

(positions)
(C)     #110 = 2*#103 (center distance)
(xCR)   #111 = 2*#103 (x position of bigger arc in the beggining)
(yCR)   #112 = 2*#103 (y position of bigger arc in the beggining)

(First calculations)
(phi) #113 = ASIN[ [#108-#109]/#110 ]
(Ax)  #114 = #111 + #108*SIN[#113]
(Ay)  #115 = #112 + #108*COS[#113]

(Laser On and Path----------------------------------------)
N120
G00 X [#114] Y [#115] Z [#100] (move head to initial position A)
M3 S100 F100 (turn on spindle, at 100 rpm and 15mm/s feedrate)

(h_count) #200 = #100 (current height)
N130
WHILE[#200 LE #106] DO 1
 
  (calculate new parameters)
  (Bx) #116 = #114                            (Bx = Ax)
  (By) #117 = #115 - 2 * #108 * COS[#113]     

  (Cx) #118 = #111 + #110 + #109 * COS[#113]
  (Cy) #119 = #112 - #109 * COS[#113]       
  (Dx) #120 = #118
  (Dy) #121 = #112 + #109 * COS[#113]

  IF [#108 EQ #109] GOTO 140 (if R == r, goto 140)

  IF [#108 GT #109] GOTO 150 (if R > r, goto 150)

  IF [#108 LT #109] GOTO 160 (else, goto 160)

  N140
    (create the profile using relative positions with arcs AB and BC only)
    G03 X[#116-#114] Y[#117-#115] R[#108]   (move around arc from point A to point B)
    G01 X[#118-#116] Y[#119-#117]           (move in line from B to C)
    G03 X[#120-#118] Y[#121-#119] R[#109]   (move around arc from point C to point D)
    G01 X[#114-#120] Y[#115-#121]           (move in line from D to A)
  GOTO 170

  N150
    (create the profile using relative positions including arcs AA' and B'B)
    (A'x) #150 = #111
    (A'y) #151 = #112 + #108
    (B'x) #152 = #150
    (B'y) #153 = #112 - #108

    G03 X[#150-#114] Y[#151-#115] R[#108]   (move around arc from point A to point A')
    G03 X[#152-#150] Y[#153-#151] R[#108]   (move around arc from point A' to point B')
    G03 X[#116-#152] Y[#117-#153] R[#108]   (move around arc from point B' to point B)
    G01 X[#118-#116] Y[#119-#117]           (move in line from B to C)
    G03 X[#120-#118] Y[#121-#119] R[#109]   (move around arc from point C to point D)
    G01 X[#114-#120] Y[#115-#121]           (move in line from D to A)
  GOTO 170

  N160
    (create the profile using relative positions including arcs C'C and DD')
    (C'x) #160 = #111 + #110 - #109 * SIN[#113]
    (C'y) #161 = #112 - #109 * COS[#113]
    (D'x) #162 = #160
    (D'y) #163 = #161 + 2 * #109 * COS[#113]

    G03 X[#116-#114] Y[#117-#115] R[#108]   (move around arc from point A to point B)
    G01 X[#160-#116] Y[#161-#117]           (move in line from B to C')
    G03 X[#118-#160] Y[#119-#161] R[#109]   (move around arc from point C' to point C)
    G03 X[#120-#118] Y[#121-#119] R[#109]   (move around arc from point C to point D)
    G03 X[#162-#120] Y[#163-#121] R[#109]   (move around arc from point D to point D')
    G01 X[#114-#162] Y[#115-#163]           (move in line from D' to A)

  GOTO 170

  N170
  (calculate new parameters for next loop)
  (R0) #108 = #108 - #107   (R = R - dR)
  (r0) #109 = #109 + #107   (r = r + dr)

  (Ax_old) #122 = #114 (store old value of Ax)
  (Ay_old) #123 = #115 (store old value of Ay)

  (phi) #113 = ASIN[ [#108-#109]/#110 ]   (calculate new phi)
  (Ax)  #114 = #111 + #108*SIN[#113]      (calculate new Ax)
  (Ay)  #115 = #112 + #108*COS[#113]      (calculate new Ay)

  (reposition in new point A)
  G01 X[#114-#122] Y[#115-#123] Z[#100] (move to next point A using relative position)

  (update counter)
  #200 = #200 + #100

END 1